class e extends Array{renderAll(){for(let e of this)e.render()}}class t{styleEl=void 0;insertMethod="adopt";constructor(e){this.installAddons(e,this.constructor.addons)}installAddons(e,t){for(let s in t){(0,t[s])(e)}}addStylesheetRules(e,t){return Array.isArray(e)?this.addStylesheetRulesArray(e,t):this.addStylesheetRulesObject(e,t)}getEnsureStyleSheet(e){let t,s=e||this.styleEl;if(null!=s)return s;if("sheet"==this.insertMethod&&(s=document.createElement("style"),document.head.appendChild(s),t=s.sheet),"adopt"==this.insertMethod){const e=new CSSStyleSheet;document.adoptedStyleSheets.push(e),t=e}return null==this.styleEl&&(this.styleEl=t),t}addStylesheetRulesArray(t,s){let r=this.getEnsureStyleSheet(s),n=new e,i=r;for(let e=0;e<t.length;e++){let s=t[e];this.pushResponse(n,i,s)}return n}pushResponse(e,t,s){let r=this.pushArrayRule(t,s);return e.push(r),r}getSheet(e){return this.getEnsureStyleSheet(e)}addStylesheetRulesObject(t,s){let r=this.getEnsureStyleSheet(s),n=new e,i=r;for(let e in t){let s=t[e],r=[e,Object.entries(s)];this.pushResponse(n,i,r)}return n}selectorExists(e,t){let s=this.getEnsureStyleSheet(t);for(let t of s.cssRules)if(e==t.selectorText)return!0;return!1}getRuleBySelector(e,t){let s=this.getEnsureStyleSheet(t);for(let t of s.cssRules)if(e==t.selectorText)return e}pushArrayRule(e,t){let s=this;return{conf:t,styleSheet:e,getPropStr(e){let t=1,r=e=null==e?this.conf:e;return Array.isArray(e[1][0])&&(r=r[1],t=0),s.buildPropStr(r,t)},render(e){let t=this.conf,r=e||this.getPropStr(t),n=t[0],i=s.insertRuleSelectorPropStr(this.styleSheet,n,r);this.sheetRule=this.styleSheet.rules[i],this.rule=i},replace(e){if(!this.sheetRule)return this.render(e);let t=this.sheetRule.cssText,s=`${this.conf[0]} {${null==e?this.getPropStr(this.conf):e}}`;this.styleSheet.replace(`${t} ${s}`)}}}buildPropStr(e,t=1){let s="";for(let r=e.length;t<r;t++){let r=e[t],n=r[0],i=r[1];if(this.isLiteralObject(i))for(let e in i){let t=i[e];s+=this.stringEntry(e,t,i.important)}else s+=this.stringEntry(n,i,null!=r[2])}return s}stringEntry(e,t,s=!1){return`${e}: ${t}${s?" !important":""};\n`}isLiteralObject(e){return!!e&&e.constructor===Object}insertRuleSelectorPropStr(e,t,s){let r=`${t} {${s}}`;return e.insertRule(r,e.cssRules.length)}}t.addons={};class s{sep="-";escapeRegex=/[<>*%#()=.@+?\/]/g;dcss=new t(this);constructor(e){this.conf=e||{},this.translateMap={},!1!==this.conf.addons&&this.installAddons(this.getPreAddons()),this.vendorLocked=null!=e?.vendorLocked&&e.vendorLocked,this.sep=e?.sep||this.sep,this.aliasMap={},this.parentSelector=e?.parentSelector,this.processAliases(this.conf?.aliases)}insertTranslator(e,t){this.translateMap[e]=t}getPreAddons(){return this.constructor.addons}installAddons(e){for(let t in e){(0,e[t])(this)}}generate(e){e=e||this?.document?.body;let t=Object.entries(e?.style||{});for(let[e,s]of t)this.addCamelString(e)}addCamelString(e){let t=function(e,t="-"){return e.replace(/[A-Z]+(?![a-z])|[A-Z]/g,((e,s)=>(s?t:"")+e.toLowerCase()))}(e).split("-");this.addTree(t)}addTree(e,t){let s=this.getRoot(),r=this.nodeWord(),n=[];for(let t of e){n.push(t),s[r]||(s[r]={});let e=s[r][t];null==e&&(e=s[r][t]={key:t,position:n}),s=e}return s.leaf=!0,null!=t&&(s.handler=t),s}nodeWord(){return"n"}getRoot(){return this.graph||(this.graph={[this.nodeWord()]:{},meta:{key:"root",isRoot:!0},key:"root"}),this.graph}processAliases(e){for(let t in e)this.addAliases(t,e[t])}getPrefixes(){let e=this.conf;return e.prefixes?e.prefixes:e.prefix?[e.prefix]:[]}isVendorPrefixMatch(e,t){t=null==t?this.getPrefixes():t;for(var s=0;s<t.length;s++){let r=t[s];if(e[s]!=r)return!1}return!0}aliasConvert(e){this.conf.prefixes;let t=[];for(let s of e)t.push(this.aliasMap[s]||s);return t}addAliases(e,t){for(let s of t)this.addAlias(e,s)}addAlias(e,t){this.aliasMap[t]=e}objectSplit(e,t=this.sep,s=!0){let r,n="string"==typeof e?e.split(t):e,i=this.nodeWord(),l=this.getRoot(),o=0,a=this.aliasConvert(n);if(a.length,this.isVendorPrefixMatch(a))a=a.slice(this.getPrefixes().length);else if(this.vendorLocked)return{props:void 0,values:void 0,str:e,node:r,valid:!1};for(let e of a)if(r=l[i][e],o+=1,null!=r){if(!0===r.leaf){let e=a[o],t=r[i];if(null==(t&&t[e]))break}l=r}else if(s)break;let h=a.slice(0,o),d=a.slice(o);return{props:h,values:d,str:e,node:r,valid:r&&d.length>0||!1}}objectSplitTranslateValue(e,t=this.sep,s=!0){let r=this.objectSplit(e,t,s);return this.translateValue(r)}insertLine(e,t){let s=this.objectSplit(e);return this.insertRule(s,t)}translateValue(e){let t=e.values;return t?.join(" "),this.forwardDigestKeys(e,t).join(" ")}forwardDigestKeys(e,t){let s=!0,r=t||[],n=0,i=[];for(;s;){let t=r[n],l=this.translateMap[t];l?[r,i,n]=l(e,r,i,n):i.push(r[n]),n+=1,(n>=r.length||n>100)&&(s=!1)}return i}insertRule(e,t=void 0,s=!0){let r=e?.props?.join("-"),n=this.asSelectorString(e,s);if(this.dcss.selectorExists(n))return this.dcss.getRuleBySelector(n);let i={[r]:this.translateValue(e)};t&&Object.assign(i,t);let l={insert:!0},o=e.node?.handler?.bind(e);if(o&&"function"==typeof o){let t=o(e);void 0!==t&&(l=t)}if(!1!==l.insert){let e=this.dcss.addStylesheetRules({[n]:i});return e.renderAll(),e}}insertReceiver(e,t){let s=this.addTree(e);return s.handler=t,s}asSelectorString(e,t=!0){let s;if(Array.isArray(e)){let t=e.join("-");s=this.escapeStr(t)}if("string"==typeof e&&(s=this.escapeStr(e)),e.props){let t=e.props.join("-");s=this.escapeStr(t)}e.str&&(s=this.escapeStr(e.str));let r=`.${s}`;return t?this.prependParent(r,e):r}prependParent(e,t){if(null!=this.parentSelector){return`${this.parentSelector}${e}`}return e}escapeStr(e){return e.replace(this.escapeRegex,"\\$&")}isProperty(e,t=this.sep){return 0==this.objectSplit(e).values.length}isDeclaration(e,t=this.sep){let s=this.objectSplit(e);return s.values.length>0&&s.props.length>0}getCSSText(){let e="",t=this.dcss.getSheet();for(let s of t.rules)e+=`${s.cssText};\n`;return e}captureNew(e,t,s){let r=this;for(let t of e){if(0==t.length)continue;let e=r.objectSplit(t);e.origin=s;let n=e.node?.handler;(n?n.bind(e):r.insertRule.bind(r))(e)}}processOnLoad(e,t=document){if(1==this.domContentLoaded)return this.process(e);(t||e).addEventListener("DOMContentLoaded",function(){this.process(e),this.domContentLoaded=!0}.bind(this))}process(e=document.body){this.getAllClasses(e,!0).forEach(((e,t)=>this.safeInsertMany(t,e)))}safeInsertMany(e,t){for(let s of t)this.safeInsertLine(s,e)}safeInsertLine(e,t){let s=this.objectSplit(e);s.valid&&(s.origin=t,this.insertRule(s))}getAllClasses(e=document.body,t=!1,s=!0){let r=function(e){e.classList.forEach((e=>n.add(e)))},n=new Set;return t&&(n=new Map,r=function(e){n.set(e,new Set(e.classList))}),s&&r(e),e.querySelectorAll("*").forEach(r),n}addClass(e,...t){let s=this.asNodes(e);for(let e of s)for(let s of t)for(let t of s.split(" "))e.classList.add(t)}removeClass(e,...t){let s=this.asNodes(e);for(let e of s)e.classList.remove(...t)}asNodes(e){let t=[e];return"string"==typeof e&&(t=document.querySelectorAll(e)),t}}s.addons={};class r{constructor([e]=[]){this.units=n,console.log("me:",e);let t=new s(e);t.generate(),this._graph=t;(e instanceof(this?.HTMLElement||function(){})?this.hotLoad:this.loadConfig).bind(this)(e)}hotLoad(e){console.log("Hotload"),this.loadConfig({target:e,process:!1})}loadConfig(e){if(console.log("load",e),e?.processOnLoad&&this.processOnLoad(e.processOnLoad),e?.target&&0!=e?.process&&this.process(e.target),e?.isInline){!1!==this.getParsedAttrValue("monitor",e.target)&&this._graph.monitor(e.target)}this.innerProxyHandler={reference:this,get(e,t,s){let r=this.reference;if(t in r)return r[t].bind?r[t].bind(r):r[t]},apply(e,t,s){console.log("innerProxyHandler apply...",s)}},this.innerHead=function(e){},this.proxy=new Proxy(this.innerHead,this.innerProxyHandler)}get graph(){return this._graph}get sheet(){return this._graph.dcss}get config(){return this._graph.conf}getParsedAttrValue(e,t,s=void 0){const r=(t=t||this._graph.conf.target).attributes.getNamedItem(e);if(null===r)return s;let n=r.value;if(0==n.length)return s;return JSON.parse(n)}getInstance(e){void 0===e&&(e=this.target);let t=e?.dataset?.polyclassId||e;return n.get(t)}processOnLoad(){return this._graph.processOnLoad.apply(this._graph,arguments)}process(){return this._graph.process.apply(this._graph,arguments)}add(e,t){return this._graph.addTree.apply(this._graph,arguments)}insertReceiver(e,t){return this._graph.addTree.apply(this._graph,arguments)}insertClassProps(e,t){return this._graph.insertLine.apply(this._graph,arguments)}insertRules(e){return this._graph.dcss.addStylesheetRules.apply(this._graph.dcss,arguments)}asString(){return this._graph.getCSSText()}}const n=new Map,i={safeSpace:{units:n},get(e,t,s){let r=this.getInstance();return t in r?r[t]&&r[t].bind?r[t].bind(r):r[t]:this.safeSpace[t]},newInstance(){return console.log("new instance",Array.from(arguments)),new r(Array.from(arguments))},getInstance(){return this._instance||(this._instance=this.newInstance.apply(this,arguments),this.safeSpace.instance=this._instance),this._instance},apply(e,t,s){return console.log("Polyclass apply...",e,t,s),s[0]instanceof HTMLElement?(console.log("Wrapped"),this.newInstance.apply(this,s)):this.getInstance.apply(this,s)}},l=new Proxy((function(){return console.log("new",arguments),i.newInstance.apply(i,arguments)}),i);(function(){return null!=this?.window})()&&(window.Polyclass=l);export{s as ClassGraph,t as DynamicCSSStyleSheet,l as Polyclass,e as RenderArray};
